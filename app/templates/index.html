<!-- app/templates/index.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Keeper Eligibility Checker • Low Expectations League</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      :root {
        --bg: #0b1020;
        --card: #111831;
        --muted: #94a3b8;
        --border: #22315d;
        --accent: #6ea8fe;
        --ok: #2ecc71;
        --bad: #ff6b6b;
      }
      body {
        background: var(--bg);
        color: #e6e8ef;
      }
      .hero {
        max-width: 980px;
      }
      .k-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
      }
      .step {
        font-size: 0.85rem;
        color: var(--muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .pill {
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        font-weight: 600;
      }
      .pill-ok {
        background: rgba(46, 204, 113, 0.15);
        color: var(--ok);
      }
      .pill-bad {
        background: rgba(255, 107, 107, 0.15);
        color: var(--bad);
      }
      .subtle {
        color: var(--muted);
      }
      .ghost {
        border: 1px dashed var(--border);
        background: transparent;
      }
      .divider {
        border-top: 1px solid var(--border);
        opacity: 0.6;
      }
      .small-muted {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .list-players .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 10px;
      }
      .list-players .item + .item {
        margin-top: 0.5rem;
      }
      .rd {
        font-variant-numeric: tabular-nums;
        padding: 0.15rem 0.5rem;
        border-radius: 6px;
        background: #0e1530;
        color: #bcd1ff;
      }
      .btn-primary {
        background: #3b82f6;
        border-color: #3b82f6;
      }
      .btn-primary:hover {
        background: #2563eb;
        border-color: #2563eb;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="mx-auto hero">
        <header class="mb-4">
          <h1 class="h3 mb-1">Keeper Eligibility Checker</h1>
          <div class="small-muted">
            Low Expectations League • Using ESPN data (last season: {{
            last_season }})
          </div>
        </header>

        <div class="k-card p-4 mb-4">
          <div class="row g-4">
            <div class="col-12 col-lg-5">
              <div class="step mb-2">Step 1 — Select your team</div>
              <select class="form-select" id="team" required>
                <option value="" selected disabled>
                  Choose your 2024 team…
                </option>
                {% for t in teams %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
              </select>

              <div class="mt-4">
                <div class="step mb-2">Step 2 — Pick a player (EOY roster)</div>
                <select class="form-select" id="player" disabled>
                  <option value="" selected>Choose a player…</option>
                </select>
                <div id="roster-hint" class="form-text subtle mt-2">
                  We’ll load your end-of-year roster automatically.
                </div>
              </div>

              <div class="mt-4 d-flex gap-2">
                <button class="btn btn-primary" id="check" disabled>
                  Check eligibility
                </button>
                <button class="btn btn-outline-secondary" id="reset">
                  Reset
                </button>
              </div>
            </div>

            <div class="col-12 col-lg-7">
              <div class="step mb-2">Results</div>
              <div class="p-3 k-card ghost" id="placeholder">
                Select your team, then a player to see draft round and keeper
                status.
              </div>

              <div id="results" class="d-none">
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                  <div class="pill" id="final-pill">—</div>
                  <span class="subtle">Final roster</span>
                </div>
                <div id="final-msg" class="mb-3 small-muted"></div>

                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                  <div class="pill" id="keeper-pill">—</div>
                  <span class="subtle">Keeper eligibility</span>
                </div>
                <div id="keeper-msg" class="mb-2"></div>
                <div id="keeper-bucket" class="small-muted"></div>

                <hr class="divider my-3" />

                <div class="small-muted">Draft info</div>
                <div id="draft-info" class="mt-1"></div>

                <div class="alert alert-info mt-3 small" role="alert">
                  Team limits still apply: one keeper from Rounds 1–10, one from
                  Rounds 11–16, and one Waiver Wire keeper (undrafted → 9th;
                  becomes 10th if your other keeper uses a 9th).
                </div>

                <!-- Keeper Selection Section -->
                <div id="keeper-selection" class="mt-4 d-none">
                  <hr class="divider" />
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Keeper Selection</h6>
                    <button class="btn btn-sm btn-outline-primary" id="add-keeper" disabled>
                      Add to Keepers
                    </button>
                  </div>
                  
                  <div id="keeper-limits" class="small-muted mb-3">
                    <div class="d-flex gap-3">
                      <span>1-10: <span id="limit-1-10">0/1</span></span>
                      <span>11-16: <span id="limit-11-16">0/1</span></span>
                      <span>Waiver: <span id="limit-waiver">0/1</span></span>
                    </div>
                  </div>

                  <div id="selected-keepers" class="list-players">
                    <!-- Selected keepers will be displayed here -->
                  </div>

                  <div id="no-keepers" class="text-center p-3 k-card ghost">
                    <div class="small-muted">No keepers selected yet</div>
                  </div>
                </div>
              </div>

              <div id="err" class="alert alert-danger d-none mt-2"></div>
            </div>
          </div>
        </div>

        <footer class="text-center small-muted">
          © 2025 Low Expectations League
        </footer>
      </div>
    </div>

    <script>
      const teamSel = document.getElementById("team");
      const playerSel = document.getElementById("player");
      const checkBtn = document.getElementById("check");
      const resetBtn = document.getElementById("reset");

      const placeholder = document.getElementById("placeholder");
      const results = document.getElementById("results");
      const err = document.getElementById("err");

      const finalPill = document.getElementById("final-pill");
      const finalMsg = document.getElementById("final-msg");
      const keeperPill = document.getElementById("keeper-pill");
      const keeperMsg = document.getElementById("keeper-msg");
      const keeperBucket = document.getElementById("keeper-bucket");
      const draftInfo = document.getElementById("draft-info");
      
      // Keeper selection elements
      const keeperSelection = document.getElementById("keeper-selection");
      const addKeeperBtn = document.getElementById("add-keeper");
      const selectedKeepers = document.getElementById("selected-keepers");
      const noKeepers = document.getElementById("no-keepers");
      const limit1_10 = document.getElementById("limit-1-10");
      const limit11_16 = document.getElementById("limit-11-16");
      const limitWaiver = document.getElementById("limit-waiver");

      let currentRoster = []; // [{id,name,draft_round,undrafted}]
      let selectedKeepersList = []; // [{player_id, name, bucket, draft_round, cost_round}]

      function setError(message) {
        err.classList.remove("d-none");
        err.textContent = message;
      }
      function clearError() {
        err.classList.add("d-none");
        err.textContent = "";
      }
      function showPlaceholder() {
        placeholder.classList.remove("d-none");
        results.classList.add("d-none");
      }
      function showResults() {
        placeholder.classList.add("d-none");
        results.classList.remove("d-none");
      }

      function updateKeeperLimits() {
        const counts = { "1-10": 0, "11-16": 0, "waiver": 0 };
        selectedKeepersList.forEach(keeper => {
          counts[keeper.bucket]++;
        });
        
        limit1_10.textContent = `${counts["1-10"]}/1`;
        limit11_16.textContent = `${counts["11-16"]}/1`;
        limitWaiver.textContent = `${counts["waiver"]}/1`;
      }

      function updateKeeperDisplay() {
        if (selectedKeepersList.length === 0) {
          selectedKeepers.classList.add("d-none");
          noKeepers.classList.remove("d-none");
        } else {
          selectedKeepers.classList.remove("d-none");
          noKeepers.classList.add("d-none");
          
          selectedKeepers.innerHTML = selectedKeepersList.map(keeper => `
            <div class="item">
              <div>
                <div class="fw-semibold">${keeper.name}</div>
                <div class="small-muted">${keeper.bucket} • Cost: Round ${keeper.cost_round}</div>
              </div>
              <button class="btn btn-sm btn-outline-danger" onclick="removeKeeper(${keeper.player_id})">
                Remove
              </button>
            </div>
          `).join("");
        }
        updateKeeperLimits();
      }

      function removeKeeper(playerId) {
        selectedKeepersList = selectedKeepersList.filter(k => k.player_id !== playerId);
        updateKeeperDisplay();
        checkKeeperSelection();
      }

      function checkKeeperSelection() {
        if (!playerSel.value || !teamSel.value) {
          addKeeperBtn.disabled = true;
          return;
        }

        const payload = {
          team_id: teamSel.value,
          name: playerSel.value,
          current_keepers: selectedKeepersList
        };

        fetch("/api/check_keeper_selection", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
        .then(res => res.json())
        .then(data => {
          if (data.can_add) {
            addKeeperBtn.disabled = false;
            addKeeperBtn.textContent = `Add as ${data.bucket} keeper`;
          } else {
            addKeeperBtn.disabled = true;
            addKeeperBtn.textContent = "Add to Keepers";
          }
        })
        .catch(err => {
          addKeeperBtn.disabled = true;
          addKeeperBtn.textContent = "Add to Keepers";
        });
      }

      teamSel.addEventListener("change", async () => {
        clearError();
        playerSel.innerHTML =
          '<option value="" selected>Loading roster…</option>';
        playerSel.disabled = true;
        checkBtn.disabled = true;

        const teamKey = teamSel.value;
        try {
          const res = await fetch(
            `/api/team_roster?team=${encodeURIComponent(teamKey)}`
          );
          const json = await res.json();
          if (json.error) throw new Error(json.error);
          currentRoster = json.players || [];

          // Populate dropdown
          const opts = [
            '<option value="" selected>Choose a player…</option>',
          ].concat(
            currentRoster.map((p) => {
              const rd = p.undrafted ? "UDFA" : `R${p.draft_round}`;
              return `<option value="${p.name}" data-round="${
                p.draft_round ?? ""
              }" data-undrafted="${p.undrafted}">${
                p.name
              } — <span>(${rd})</span></option>`;
            })
          );
          playerSel.innerHTML = opts.join("");
          playerSel.disabled = currentRoster.length === 0;

          if (currentRoster.length === 0) {
            setError(
              "We couldn’t find any players on your end-of-year roster. Try again in a moment, or verify team mapping."
            );
          } else {
            clearError();
          }
        } catch (e) {
          setError(e.message || "Failed to load roster.");
        }
      });

      playerSel.addEventListener("change", () => {
        checkBtn.disabled = !playerSel.value;
        if (!playerSel.value) {
          showPlaceholder();
          keeperSelection.classList.add("d-none");
          return;
        }
        // Pre-fill draft round info
        const opt = playerSel.options[playerSel.selectedIndex];
        const round = opt.getAttribute("data-round");
        const undrafted = opt.getAttribute("data-undrafted") === "true";
        const rdLabel = undrafted
          ? "Undrafted (Waiver Wire)"
          : `Drafted: Round ${round}`;
        draftInfo.textContent = rdLabel;
        showResults();
        // Reset pills
        finalPill.textContent = "—";
        finalPill.className = "pill";
        keeperPill.textContent = "—";
        keeperPill.className = "pill";
        finalMsg.textContent = "";
        keeperMsg.textContent = "";
        keeperBucket.textContent = "";
        keeperSelection.classList.add("d-none");
      });

      checkBtn.addEventListener("click", async () => {
        clearError();
        const teamKey = teamSel.value;
        const playerName = playerSel.value;
        if (!teamKey || !playerName) return;

        const payload = { team_id: teamKey, name: playerName };
        const res = await fetch("/api/check", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const json = await res.json();

        showResults();

        if (json.error) {
          setError(json.error);
          finalPill.textContent = "Error";
          finalPill.className = "pill pill-bad";
          return;
        }

        finalPill.textContent = json.final_on_roster ? "Yes" : "No";
        finalPill.className =
          "pill " + (json.final_on_roster ? "pill-ok" : "pill-bad");
        finalMsg.textContent = json.final_message;

        keeperPill.textContent = json.keeper_eligible
          ? "Eligible"
          : "Not eligible";
        keeperPill.className =
          "pill " + (json.keeper_eligible ? "pill-ok" : "pill-bad");
        keeperMsg.textContent = json.keeper_message || "";
        keeperBucket.textContent = json.keeper_bucket
          ? `Bucket: ${json.keeper_bucket}`
          : "";

        // If server returns authoritative draft info, prefer it
        const rd = json.undrafted ? null : json.draft_round;
        draftInfo.textContent = json.undrafted
          ? "Undrafted (Waiver Wire)"
          : rd
          ? `Drafted: Round ${rd}`
          : "Draft round unknown";

        // Show keeper selection if player is eligible
        if (json.keeper_eligible) {
          keeperSelection.classList.remove("d-none");
          checkKeeperSelection();
        } else {
          keeperSelection.classList.add("d-none");
          addKeeperBtn.disabled = true;
        }
      });

      addKeeperBtn.addEventListener("click", async () => {
        if (!playerSel.value || !teamSel.value) return;

        const payload = {
          team_id: teamSel.value,
          name: playerSel.value,
          current_keepers: selectedKeepersList
        };

        try {
          const res = await fetch("/api/check_keeper_selection", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          if (data.can_add) {
            selectedKeepersList.push({
              player_id: data.player_info.id,
              name: data.player_info.name,
              bucket: data.bucket,
              draft_round: data.player_info.draft_round,
              cost_round: data.cost_round
            });
            updateKeeperDisplay();
            checkKeeperSelection();
          }
        } catch (err) {
          console.error("Failed to add keeper:", err);
        }
      });

      resetBtn.addEventListener("click", () => {
        teamSel.value = "";
        playerSel.innerHTML =
          '<option value="" selected>Choose a player…</option>';
        playerSel.disabled = true;
        checkBtn.disabled = true;
        currentRoster = [];
        selectedKeepersList = [];
        updateKeeperDisplay();
        keeperSelection.classList.add("d-none");
        clearError();
        showPlaceholder();
      });

      // initial state
      showPlaceholder();
    </script>
  </body>
</html>
